<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Functionality Test - RaveLasers</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: Arial, sans-serif; 
            background: #000; 
            color: #fff;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: #222;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #444;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.secondary {
            background: #2196F3;
        }
        .test-button.secondary:hover {
            background: #0b7dda;
        }
        .test-button.danger {
            background: #f44336;
        }
        .test-button.danger:hover {
            background: #da190b;
        }
        .status {
            background: #111;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
            font-family: monospace;
            min-height: 20px;
        }
        .status.error {
            border-left-color: #f44336;
        }
        .status.info {
            border-left-color: #2196F3;
        }
        .viewer {
            width: 100%;
            height: 400px;
            border: 2px solid #444;
            border-radius: 10px;
            background: #000;
        }
        h1, h2 {
            color: #4CAF50;
        }
        h3 {
            color: #2196F3;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🚀 RaveLasers Final Functionality Test</h1>
        
        <!-- Status Overview -->
        <div class="test-section">
            <h2>📊 System Status</h2>
            <div id="systemStatus" class="status">Initializing...</div>
            <button class="test-button" onclick="checkSystemStatus()">🔍 Check System Status</button>
            <button class="test-button secondary" onclick="showSystemInfo()">📋 Show System Info</button>
        </div>

        <!-- Default Behavior Test -->
        <div class="test-section">
            <h2>🎯 Default Behavior Test</h2>
            <p>Test if the fallback red laser behavior loads automatically when no saved defaults exist.</p>
            <div id="defaultBehaviorStatus" class="status">Ready to test...</div>
            <button class="test-button" onclick="testDefaultBehavior()">🔴 Test Default Fallback</button>
            <button class="test-button secondary" onclick="clearAllDefaults()">🗑️ Clear All Defaults</button>
        </div>

        <!-- Array Effect Test -->
        <div class="test-section">
            <h2>🌈 Array Effect Test</h2>
            <p>Test the enhanced array_1 behavior with 3-phase animation (static → spread → full array).</p>
            <div id="arrayStatus" class="status">Ready to test...</div>
            <button class="test-button" onclick="testArrayEffect()">🚀 Test Array Effect</button>
            <button class="test-button secondary" onclick="loadPresetArrayBehavior()">📋 Load array_1 Preset</button>
        </div>

        <!-- Create Command Test -->
        <div class="test-section">
            <h2>⚡ Create Command Test</h2>
            <p>Test the create command that clones behaviors and registers them dynamically.</p>
            <div id="createStatus" class="status">Ready to test...</div>
            <button class="test-button" onclick="testCreateCommand()">🛠️ Test Create Command</button>
            <button class="test-button secondary" onclick="listCreatedBehaviors()">📋 List Created Behaviors</button>
            <button class="test-button danger" onclick="clearCreatedBehaviors()">🗑️ Clear Created</button>
        </div>

        <!-- Manual CLI Test -->
        <div class="test-section">
            <h2>💻 Manual CLI Commands</h2>
            <p>Test CLI commands manually in the console:</p>
            <div class="status">
                <div><strong>Available Commands:</strong></div>
                <div>• <code>load-behavior array_1</code> - Load array effect</div>
                <div>• <code>create my_test_behavior</code> - Create new behavior</div>
                <div>• <code>status</code> - Show current status</div>
                <div>• <code>show-saved</code> - Show all saved behaviors/banks</div>
                <div>• <code>clear-all</code> - Clear everything and start fresh</div>
            </div>
        </div>

        <!-- 3D Viewer -->
        <div class="test-section">
            <h2>🎬 3D Viewer</h2>
            <iframe id="viewer" class="viewer" src="index.html"></iframe>
            <div style="margin-top: 10px;">
                <button class="test-button" onclick="openMainApp()">🖼️ Open Main App</button>
                <button class="test-button secondary" onclick="openArrayTest()">🌈 Open Array Test</button>
                <button class="test-button secondary" onclick="openCreateTest()">⚡ Open Create Test</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { CLI } from './CLI.js';
        
        let testCLI;
        let systemReady = false;

        // Initialize test system
        window.addEventListener('load', async () => {
            try {
                // Wait for the main app to load in the iframe
                setTimeout(() => {
                    initializeTestSystem();
                }, 2000);
            } catch (error) {
                updateStatus('systemStatus', `❌ Initialization error: ${error.message}`, 'error');
            }
        });

        async function initializeTestSystem() {
            try {
                // Check if we can access the iframe's window
                const iframe = document.getElementById('viewer');
                const iframeWindow = iframe.contentWindow;
                
                if (iframeWindow && iframeWindow.presetManager) {
                    systemReady = true;
                    updateStatus('systemStatus', '✅ System ready! PresetManager and LaserSystem available.', 'success');
                } else {
                    updateStatus('systemStatus', '⚠️ System loading... PresetManager not yet available.', 'info');
                    // Try again in 2 seconds
                    setTimeout(initializeTestSystem, 2000);
                }
            } catch (error) {
                updateStatus('systemStatus', `❌ Cannot access iframe: ${error.message}`, 'error');
            }
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function getIframeSystem() {
            const iframe = document.getElementById('viewer');
            return iframe.contentWindow;
        }

        // Test Functions
        window.checkSystemStatus = function() {
            try {
                const iframeWindow = getIframeSystem();
                if (!iframeWindow || !iframeWindow.presetManager) {
                    updateStatus('systemStatus', '❌ System not ready. PresetManager not available.', 'error');
                    return;
                }

                const presetManager = iframeWindow.presetManager;
                const laserSystem = iframeWindow.laserSystem;
                
                updateStatus('systemStatus', 
                    `✅ System Status: PresetManager ✓, LaserSystem ✓, Active Behaviors: ${laserSystem.activeBehaviors.length}`, 
                    'success'
                );
            } catch (error) {
                updateStatus('systemStatus', `❌ Error checking status: ${error.message}`, 'error');
            }
        };

        window.showSystemInfo = function() {
            try {
                const iframeWindow = getIframeSystem();
                if (!iframeWindow || !iframeWindow.presetManager) {
                    updateStatus('systemStatus', '❌ System not ready.', 'error');
                    return;
                }

                // Call the status command in the iframe
                iframeWindow.presetManager.showStatus();
                updateStatus('systemStatus', '📋 System info logged to console (check browser dev tools)', 'info');
            } catch (error) {
                updateStatus('systemStatus', `❌ Error showing info: ${error.message}`, 'error');
            }
        };

        window.testDefaultBehavior = function() {
            try {
                const iframeWindow = getIframeSystem();
                if (!iframeWindow || !iframeWindow.presetManager) {
                    updateStatus('defaultBehaviorStatus', '❌ System not ready.', 'error');
                    return;
                }

                const presetManager = iframeWindow.presetManager;
                const laserSystem = iframeWindow.laserSystem;
                
                // Clear all and trigger default loading
                presetManager.clearAll();
                
                // Check if fallback behavior loaded
                setTimeout(() => {
                    if (laserSystem.activeBehaviors.length > 0) {
                        updateStatus('defaultBehaviorStatus', 
                            `✅ Fallback behavior loaded! Active behaviors: ${laserSystem.activeBehaviors.length}`, 
                            'success'
                        );
                    } else {
                        updateStatus('defaultBehaviorStatus', '❌ No fallback behavior loaded.', 'error');
                    }
                }, 1000);
                
            } catch (error) {
                updateStatus('defaultBehaviorStatus', `❌ Error: ${error.message}`, 'error');
            }
        };

        window.clearAllDefaults = function() {
            try {
                const iframeWindow = getIframeSystem();
                if (!iframeWindow || !iframeWindow.presetManager) {
                    updateStatus('defaultBehaviorStatus', '❌ System not ready.', 'error');
                    return;
                }

                iframeWindow.presetManager.clearAll();
                updateStatus('defaultBehaviorStatus', '🗑️ All defaults cleared. Page refresh will test fallback loading.', 'info');
            } catch (error) {
                updateStatus('defaultBehaviorStatus', `❌ Error: ${error.message}`, 'error');
            }
        };

        window.testArrayEffect = function() {
            try {
                const iframeWindow = getIframeSystem();
                if (!iframeWindow || !iframeWindow.presetManager) {
                    updateStatus('arrayStatus', '❌ System not ready.', 'error');
                    return;
                }

                const presetManager = iframeWindow.presetManager;
                
                // Load array_1 behavior
                const success = presetManager.loadBehavior('array_1');
                if (success) {
                    updateStatus('arrayStatus', 
                        '🌈 Array effect loaded! Watch for: 1s static → 3s spread → continuous array pattern', 
                        'success'
                    );
                } else {
                    updateStatus('arrayStatus', '❌ Failed to load array_1 behavior.', 'error');
                }
            } catch (error) {
                updateStatus('arrayStatus', `❌ Error: ${error.message}`, 'error');
            }
        };

        window.loadPresetArrayBehavior = function() {
            try {
                const iframeWindow = getIframeSystem();
                if (!iframeWindow || !iframeWindow.presetManager) {
                    updateStatus('arrayStatus', '❌ System not ready.', 'error');
                    return;
                }

                // Show available behaviors
                const behaviors = iframeWindow.presetManager.listBehaviors();
                updateStatus('arrayStatus', `📋 Available behaviors: ${behaviors.join(', ')}`, 'info');
            } catch (error) {
                updateStatus('arrayStatus', `❌ Error: ${error.message}`, 'error');
            }
        };

        window.testCreateCommand = function() {
            try {
                const iframeWindow = getIframeSystem();
                if (!iframeWindow || !iframeWindow.CLI) {
                    updateStatus('createStatus', '❌ CLI not available in iframe.', 'error');
                    return;
                }

                // Try to execute create command
                const testName = `test_behavior_${Date.now()}`;
                const cli = iframeWindow.CLI;
                
                // Simulate create command
                updateStatus('createStatus', `⚡ Creating behavior: ${testName}...`, 'info');
                
                // Note: This would need the CLI instance to be accessible
                updateStatus('createStatus', 
                    `⚠️ Use console command: create ${testName}`, 
                    'info'
                );
            } catch (error) {
                updateStatus('createStatus', `❌ Error: ${error.message}`, 'error');
            }
        };

        window.listCreatedBehaviors = function() {
            try {
                const iframeWindow = getIframeSystem();
                if (!iframeWindow || !iframeWindow.presetManager) {
                    updateStatus('createStatus', '❌ System not ready.', 'error');
                    return;
                }

                const behaviors = iframeWindow.presetManager.listBehaviors();
                const created = behaviors.filter(name => name.includes('test_') || name.includes('created_'));
                
                if (created.length > 0) {
                    updateStatus('createStatus', `📋 Created behaviors: ${created.join(', ')}`, 'success');
                } else {
                    updateStatus('createStatus', '📋 No created behaviors found.', 'info');
                }
            } catch (error) {
                updateStatus('createStatus', `❌ Error: ${error.message}`, 'error');
            }
        };

        window.clearCreatedBehaviors = function() {
            try {
                const iframeWindow = getIframeSystem();
                if (!iframeWindow || !iframeWindow.presetManager) {
                    updateStatus('createStatus', '❌ System not ready.', 'error');
                    return;
                }

                // Clear localStorage to remove created behaviors
                iframeWindow.localStorage.clear();
                updateStatus('createStatus', '🗑️ Cleared created behaviors from localStorage.', 'info');
            } catch (error) {
                updateStatus('createStatus', `❌ Error: ${error.message}`, 'error');
            }
        };

        // Navigation Functions
        window.openMainApp = function() {
            window.open('index.html', '_blank');
        };

        window.openArrayTest = function() {
            window.open('test-array-effect.html', '_blank');
        };

        window.openCreateTest = function() {
            window.open('test-create-command.html', '_blank');
        };
    </script>
</body>
</html>
